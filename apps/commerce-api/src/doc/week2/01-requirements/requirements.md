# ✍️ 요구사항 정리

## 📋요구사항 대상
> - 상품 목록 / 상품 상세 / 브랜드 조회
> - 상품 좋아요 등록 / 취소 / 조회 (멱등 동작)
> - 주문 생성 및 결제 흐름 (재고 차감, 포인트 차감, 외부 시스템 연동)

---

## 📋유저 스토리

### <상품 조회>
> - 상품 목록 페이지에 진입 시 상품 정보 목록을 조회한다.
> - 상품 상세 페이지에 진입 시 상품 상세 정보를 조회한다.
> - 브랜드 페이지에 진입 시 브랜드 정보를 조회한다.

### <상품 좋아요>
상품 목록, 상세 페이지에서...
> - 상품 좋아요 등록하고 취소할 수 있어야 한다.
> - "좋아요" 표시한 상품 목록 조회하기

### <주문과 결제>
주문하기 버튼을 클릭 시...
> - 상품을 주문한다.
>  - 결제도 같이 이루어진다.
>  - 주문한 상품의 재고가 차감된다.
>  - 주문에 사용된 포인트 차감된다. 포인트로만 결제하게 만든다.
>  - 외부 시스템(eg. PG)과 연동된다. (지금은 mock 로만 구현)
>  - 여러 상품을 한 번에 주문, 결제할 수 있어야 한다.

마이페이지 > 주문배송조회 페이지에서...
> - 유저의 주문 목록 조회한다.
> - 유저의 단일 주문 상세를 조회한다.

---

## 📋기능 흐름

### <상품 조회>
**상품 목록 조회**
> 1. 상품 목록 조회 함수 호출
>   1. 상품 도메인 엔티티를 조회하기
>   2. 페이지 번호와 상품 개수 조건을 적용하여 조회하기 (페이징)
>   3. 파라미터에 따라 최신, 최저가, 좋아요 최대수 순으로 정렬하게 하기
>   4. 브랜드ID가 있으면 그 브랜만 필터링해서 조회하기
> 2. 200 응답, 상품 목록용 DTO 를 Response 에 담아 보내기

**상품 상세 조회**
> 1. 상품 상세 조회 함수 호출
>   - 상품ID에 맞는 상품 도메인 엔티티를 조회하기
> 2. 200 응답, 상품 상세용 DTO 를 Response 에 담아 보내기

**브랜드 조회**
> 1. 브랜드 정보 조회 함수 호출
>   - 브랜드ID의 브랜드 도메인 엔티티를 조회하기
> 2. 200 응답, 브랜드용 DTO 를 Response 에 담아 보내기

### <상품 좋아요>
**상품 좋아요 등록**
> 1. 상품 좋아요 등록 함수 호출
>   - X-USER-ID 의 유저ID와 상품ID 로 상품 좋아요 객체 생성 후 저장하기
>   - userId 와 targetId(상품, 브랜드, 셀러 등등) Composite key 를 활용하여 두 번 등록되지 않게 하기
>   - 그러나 Exception 을 일으키는 것은 아니고 save() 함수로 덮어쓰게 해서 멱등성 확보하기
> 2. 응답 보내기
>   - 만약 등록에 성공하면 201 으로 응답하기
>   - 만약 중복으로 인해 등록에 실패하면 204 로 응답하기

**상품 좋아요 취소**
> 1. 상품 좋아요 취소 함수 호출
>   - X-USER-ID 의 유저ID와 상품ID로 상품 좋아요 데이터 삭제하기
> 2. 응답 보내기
>   - 만약 삭제에 성공하면 200 로 응답하기
>   - 만약 이미 삭제되었다면 등록에 실패하면 204 로 응답하기
>     - 데이터가 있는지 확인하는 JPA 함수 활용해야 할 것 같다.

**"좋아요" 표시한 상품 목록 조회**
> 1. "좋아요" 표시한 상품 목록 조회 함수 호출
>   1. X-USER-ID 의 유저ID로 상품 엔티티 목록을 가져오기
>   2. 페이지 번호와 상품 개수 조건을 적용하여 조회하기 (페이징)
>   3. 파라미터에 따라 최신, 최저가, 좋아요 최대수 순으로 정렬하게 하기
>   4. 브랜드ID가 있으면 그 브랜만 필터링해서 조회하기
> 2. 200 응답, 상품 목록용 DTO 를 Response 에 담아 보내기

### <주문과 결제>
**상품 주문**
> 1. 주문 함수 호출
>   1. X-USER-ID 의 유저ID, 상품ID, 개수로 주문 저장하기
>      1. 주문 객체 생성 후 저장하기
>      2. 주문 상품 객체도 생성 후 저장하기
>   2. 주문한 상품의 재고를 차감하기
>      - `만약 재고가 없으면 "재고 없음" 메세지와 함께 400 응답을 보내기`
>   3. 총 결제 금액을 계산한 뒤 유저의 보유 포인트 액수와 비교하기
>      - 만약 충분하면 포인트 차감
>      - `결제 실패 시 재고를 다시 채우고 주문 객체의 주문상태를 "결제 실패" 로 변경하고 400 응답을 보내기`
>   4. 외부 시스템 전송하기 (Mock 처리)
> 2. 200 응답 보내기

**유저의 주문 목록 조회**
> 1. 주문 목록 조회 함수 호출
>   - X-USER-ID 의 유저ID 을 조건으로 주문 객체 리스트를 가져오기
> 2. 200 응답, 주문 목록용 DTO 를 Response 에 담아 보내기

**유저의 주문 상세 조회**
> 1. 주문 상세 조회 함수 호출
>   - X-USER-ID 의 유저ID 을 조건으로 주문 객체를 가져오기
> 2. 200 응답, 주문 목록용 DTO 를 Response 에 담아 보내기

---

## 📋참고해야 할 조건/예외사항
> 1. "상품 좋아요"와 "상품 주문/결제"는 로그인해야 만 사용할 수 있다. (X-USER-ID 가 필요함)
> 2. 목록 조회의 경우, API 의 응답이 빈 객체다. 단일 조회는 Exception 을 일으킨다.

---

## 💬유비쿼터스 언어
### 도메인 용어 정리
```
상품 → Product
브랜드 → Brand
좋아요 → Like
주문 → Order
주문 상품 -> OrderItem
결제 -> Payment
재고 -> Stock
포인트 -> Point
회원 -> User
```